#!/bin/bash

printUsage()
{
    cat <<HELPTEXT
Tests whether the passed EXECUTABLE exists in PATH. If not, it asks the user
whether to define it. If confirmed, this will execute the shell COMMANDS read
from stdin.
HELPTEXT
printf 'Usage: echo COMMANDS | %q %s\n' "$(basename "$1")" '[--bare|[--trailing-prompt] [--emulate-prompt] [--worst-status] [-c|--comment COMMENT]] EXECUTABLE [-?|-h|--help]'
printf 'Usage: %q %s <<EOF\n  COMMANDS\nEOF\n' "$(basename "$1")" '[...] EXECUTABLE'
}
isBare=
case "$1" in
    --help|-h|-\?)	shift; printUsage "$0"; exit 0;;
    --bare)		shift; isBare=t;;
esac
if [ $# -lt 1 ]; then
    printUsage "$0" >&2
    exit 2
fi
EXECUTABLE=; [ $# -gt 0 ] && EXECUTABLE=${!#}
typeset -a runWithPromptArgs=("${@:1:$(($#-1))}")

'which' "$EXECUTABLE" >/dev/null 2>&1 && exit 0

MARKER_FILESPEC="$(echo "${TEMP:-/tmp}/$(basename -- "$0").$PPID")"

if [ -e "$MARKER_FILESPEC" ] && [ "$(find "$MARKER_FILESPEC" -mmin -15)" ]; then
    printf '%s does not exist. Defining it now.\n' "$EXECUTABLE"
    CHOICE=y
else
    < /dev/tty read -p "$EXECUTABLE does not exist. Define it? (y/n/a) " CHOICE
fi
if [ "$CHOICE" = 'a' ]; then
    touch "$MARKER_FILESPEC"
    CHOICE=y
fi

[ "$CHOICE" = 'y' ] || exit 2

if [ "$isBare" ]; then
    cat | bash -
else
    runWithPrompt "${runWithPromptArgs[@]}"
fi
